---
output: 
   html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=F}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	comment = F
)
```

# Guatemala IOM project demo

## Migration, conflict and GBV rates

Visualization including pop-up variables  

Click on the IOM returns layer to view returns in each year per municipality  

Click on the domestic violence layer to view the men and women affected in each municipality  

Maintain the municipality boundaries layer when viewing the IOM returns and Domestic violence layers.

```{r, echo=FALSE,warning=FALSE,message=FALSE,error=FALSE,fig.keep='all'}
rm(list=ls(all=TRUE))
library(geojsonio)
library(geojsonsf)
library(geodata)
library(sf)
library(tmap)
library(readxl)

#reading the geojson megapixels
#rpath <- "D:/OneDrive - CGIAR/Analysis/Team/korir/Guatemala/"
rpath <- 'D:/OneDrive - CGIAR/Guatemala/'
GTM_mpixels <- st_read(paste0(rpath,'GTM_megapixels.geojson'), quiet = T)
GTM_mpixels$clust[GTM_mpixels$conflict_clust_short_label=='High'] <- 3
GTM_mpixels$clust[GTM_mpixels$conflict_clust_short_label=='Moderate'] <- 2
GTM_mpixels$clust[GTM_mpixels$conflict_clust_short_label=='Limited'] <- 1

#GTM_mpixels$clust <- as.integer(GTM_mpixels$clust)
#GTM admin level2
<<<<<<< HEAD
GTM_adm1 <- sf::st_as_sf(geodata::gadm(country = 'GTM', version =  "latest" , level = 1, path = tempdir() ))
GTM_adm2 <- sf::st_as_sf(geodata::gadm(country = 'GTM', version =  "latest" ,level = 2, path = tempdir() ))
=======
GTM_adm1 <- sf::st_as_sf(geodata::gadm(country = 'GTM',level = 1,version="latest", path = tempdir() ))
#GTM_adm2 <- sf::st_as_sf(geodata::gadm(country = 'GTM',level = 2,version="latest", path = tempdir() ))
>>>>>>> a85c32a910668139a98b316c0e0adc3d99202c7c


#Loading updated shapefile from HDX https://data.humdata.org/dataset/cod-ab-gtm?
GTM_adm2 <- st_read(paste0(rpath,"gtm_adm_ocha_conred_2019_SHP/gtm_admbnda_adm2_ocha_conred_20190207.shp"), quiet = T)
Guatemala_IOM_returns <- read_excel(paste0(rpath,"Guatemala_IOM_returns_x.xlsx"))
#my_data <- read.delim("Guatemala_IOM_returns.csv", header = TRUE, sep = "\t", dec = ",",)
colnames(Guatemala_IOM_returns) =  gsub('in\r\n', '', Guatemala_IOM_returns[1,])#gsub('.*\n', '', Guatemala_IOM_returns[1,])
Guatemala_IOM_returns <- Guatemala_IOM_returns[-c(1,2), ]
names(Guatemala_IOM_returns)[1] <- 'Municipality'
#Guatemala_IOM_returns <- Guatemala_IOM_returns[,-7]
GTM_GBV_Summarized <- read_excel(paste0(rpath,"Domestic_violence.xlsx"))
names(GTM_adm2)[3] <- 'Municipality'


#Guatemala_IOM_returns$Municipality <- toupper(Guatemala_IOM_returns$Municipality)
#GTM_adm2$Municipality <- toupper(GTM_adm2$Municipality)
#setdiff(unique(Guatemala_IOM_returns$Municipality), unique(GTM_adm2$Municipality))
i = unique(Guatemala_IOM_returns$Municipality) %in% unique(GTM_adm2$Municipality)
#Guatemala_IOM_returns$Municipality[!i] #Show values missing in GTM_adm2



#Merging data
gbv_iom <- merge(Guatemala_IOM_returns, GTM_GBV_Summarized,all.x=T)
dff <- merge(GTM_adm2, gbv_iom, by = 'Municipality')
#GTM_GBV_Summarized$Municipality <- toupper(GTM_GBV_Summarized$Municipality)
##merged_adm2_GBV <- merge(GTM_adm2, GTM_GBV_Summarized, by = c('Municipality'))
#merged_adm2_GBV_IOM <- merge(merged_adm2_GBV, Guatemala_IOM_returns,all.y=T)

#Coercing Returns to numeric before plotting
dff$`Returns 2018-2021` <- as.numeric(dff$`Returns 2018-2021`)

#plotting Migration, conflict and GBV rates
tmap_mode('view')
<<<<<<< HEAD
tm_shape(dff, name ='GBV') +
  tm_fill(col = "Rate",NA.col = "transparent", style = 'cont',
          popup.vars=c("Department" ,"Municipality", "Rate","Returns 2018","Returns 2019", 
=======
  tm_shape(dff, name = 'IOM returns') +
  tm_fill(col = "Returns 2018-2021",NA.col = "transparent", style = 'cont',
          popup.vars=c("Municipality","Returns 2018","Returns 2019", 
>>>>>>> a85c32a910668139a98b316c0e0adc3d99202c7c
                       "Returns 2020", "Returns 2021", "Returns 2018-2021")) +
  tm_shape(dff, name = 'Domestic Violence') +
  tm_fill(col = "Both Sex Affected",NA.col = "transparent", style = 'cont',popup.vars=c("Men","Women")) +
  tm_shape(GTM_mpixels, name = 'Climate Conflict Intersection') +
  tm_fill(col = "clust",  palette= "YlOrRd", legend.show = F, 
            popup.vars = c('intersect_conf_clim', "FATALITIES","pop", "migration", "female_population")) +
  tm_shape(GTM_adm2, name= 'Municipality')+
  tm_borders(lwd = 1, col = "black")
```




```{r k4, eval=FALSE, include=FALSE}
tmap_mode('view')
tm_shape(GTM_mpixels) +
  tm_fill(col = "clust",  palette= "YlOrRd", legend.show = F, 
          popup.vars = c('intersect_conf_clim', "FATALITIES","pop", "migration", "female_population")) +
  tm_shape(GTM_adm1)+
  tm_borders(lwd = 1, col = "black") +
  tm_text(text = "NAME_1", size = 1, col = "black") #+
  #tm_legend(title ='Climate Conflict Intersections')


```

